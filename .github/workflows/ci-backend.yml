name: ci-backend
on:
  pull_request:
    paths:
      - "go-backend/**"
      - ".github/workflows/ci-backend.yml"
      - "!**.md"
      - "!Makefile"
      - "!go-backend/docker-compose.yml"
      - "!go-backend/.gitignore"
  push:
    branches:
      - 'main'
    paths:
      - "go-backend/**"
      - ".github/workflows/ci-backend-lint.yml"
      - "!**.md"
      - "!Makefile"
      - "!docker-compose.yml"
      - "!go-backend/docker-compose.yml"
      - "!go-backend/.gitignore"

permissions:
  contents:      read

jobs:
  lint:
    name: lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: go-backend

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Setup backend
        uses: ./.github/actions/setup-backend
        with:
          go-version: '1.25.6'
          sqlc-version: '1.30.0'
      - name: Setup golang-ci
        uses: golangci/golangci-lint-action@1e7e51e771db61008b38414a730f564565cf7c20 # v9.2.0
        with:
          version: v2.8
          install-only: true
      - name: Lint
        run: make lint

  test-coverage:
    name: Test coverage
    runs-on: ubuntu-latest
    needs: lint
    defaults:
      run:
        working-directory: go-backend

    services:
      postgres:
        image: postgres:18.2
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: it
        ports:
          # Maps tcp port 5432 on service container to the host
          - 5432:5432

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Setup backend
        uses: ./.github/actions/setup-backend
        with:
          go-version: '1.25.6'
          sqlc-version: '1.30.0'
      - name: Run test
        run: make test-coverage
        env:
          CI: true
          DATABASE_DSN: postgres://postgres:postgres@localhost:5432/it
      - name: Archive code coverage results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: backend-code-coverage
          path: go-backend/coverage.out

  coverage-report:
    name: "Code coverage report"
    if: ${{ github.event_name == 'pull_request' && github.base_ref == 'main' }}
    runs-on: ubuntu-latest
    needs: test-coverage
    defaults:
      run:
        working-directory: go-backend
    permissions:
      contents:      read
      actions:       read  # to download code coverage results from "test" job
      pull-requests: write # write permission needed to comment on PR
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - uses: fgrosse/go-coverage-report@ba3f798d6f32b9b16faea37cc7192261bb25b192 # v1.1.1
        with:
          coverage-artifact-name: "backend-code-coverage"
          coverage-file-name: "coverage.out"
