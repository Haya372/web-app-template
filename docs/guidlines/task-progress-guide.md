# タスクの進め方ガイド

## 目的
このドキュメントは、開発タスクを見える化しつつ確実に完了させるための標準フローをまとめたものです。チケット起票から TDD を用いた実装・検証までのプロセスを揃え、生産性と品質の両立を狙います。

## チケット作成
- 必ずテンプレートを使って背景・目的・やること・完了条件を明示する
- 課題が曖昧な場合は、観測された事実と制約を整理してレビュー可能な情報量を担保する
- 完了条件は客観的に検証できる形 (テスト観点、期待される出力、UI ステート等) で列挙する
- 規模が大きい場合はサブタスクやメトリクスを追加し、誰が見ても進捗と Done の定義が分かるようにする
- 要件と設計 (Backend の API 仕様、Frontend の UI 遷移など) をテンプレートに沿って書き、設計議論を非同期でレビュー可能にする

### チケットテンプレート
以下のテンプレートをコピーして必要箇所を埋めてください。`[]` 付きの行はチェックリスト、`-` は箇条書きで記述します。

---
**テンプレート**

**サマリ**
- 1 行でタスクの意図を説明

**背景 / 課題**
- どのような状況で何が問題になっているかを Fact ベースで記載

**目的 / 成功基準**
- "〇〇ができる状態" のように達成後の姿を宣言
- 主要な KPI や期待値 (例: レスポンス時間 < 200ms) があれば合わせて記載

**スコープ**
- 対象となる機能やコンポーネント
- 対象外・やらないことも明示

**要件 / 設計**
- Backend: 下記フォーマットで API 仕様を書く (エンドポイント、Header テーブル、Request/Response サンプル、バリデーション、エラー一覧)
- Frontend: ページパス、ユーザーフロー (どの操作でどの API/イベントが発火するか)、画面状態と遷移 (成功/失敗/ローディング等) を詳細化する
- 共通: 状態遷移図や ER 図などのリンク、非機能要件 (パフォーマンス、アクセス制御) があれば記載
- DB / Migration: 変更が必要な場合は下記フォーマットで記載 (テーブル名、各カラム、制約、seed データ)
- 監視/観測: 追加すべきメトリクス、ログ、アラート条件、既存ダッシュボードへの反映有無を明確にする

**Backend 記載フォーマット例**
- エンドポイント: `<METHOD> /path`
- Headers:
  | Header | 必須 | 値 | 備考 |
  | --- | --- | --- | --- |
  | Authorization | ○ | `Bearer <token>` | scope: `auth.login` |
- Body (JSON サンプル)
  ```json
  {
    "field": "value"
  }
  ```
- Response (200) サンプル JSON
- Errors: 400/401/429 などコードとメッセージ、トレース方法を明記

**Frontend 記載フォーマット例**
- ページ: `/login`
- イベント: 「SubmitButton クリック or Enter」→ `callLogin()` → 成功で `/dashboard` へ `router.push`
- UI 状態: loading/disabled、エラー表示メッセージ、フォーカス制御

**DB / Migration 記載フォーマット例**
- 対象テーブル: `users`
- 変更内容:
  | カラム | 型 | NULL | デフォルト | 制約/インデックス | 備考 |
  | --- | --- | --- | --- | --- | --- |
  | id | uuid | NO | `gen_random_uuid()` | PK | |
  | email | text | NO | | UNIQUE | |
  | password_hash | text | NO | | | |
- 追加/変更制約: `users_email_unique` など
- seed データ:
  | 用途 | 件数 | 内容 |
  | --- | --- | --- |
  | 開発用 | 2 | admin/test ユーザーを作成 |

**やること**
- 作業ごとに観測可能なアウトプット単位でタスクを分割 (例: ドメイン実装、HTTP ハンドラ、UI、ドキュメント)
- 依存関係がある場合は順番を意識して並べる
- 例:
  - [ ] Backend: ドメインロジック/ユースケース
  - [ ] Backend: HTTP 層と Wire 配線
  - [ ] Frontend: `/login` ページ実装と UI 文言
  - [ ] QA/Docs: 受け入れ手順やモニタリング設定の追記

**完了条件**
- [ ] ユニットテストが通過する
- [ ] 受け入れ観点 A が満たされる
- [ ] ドキュメント更新 (該当箇所)

**テスト (受け入れ観点)**
- 人が行う受け入れテストや E2E/インテグレーションテストで検証すべき観点を箇条書きにする
- 例: 「正常系: `POST /v1/users` に valid payload を送ると 201 とユーザー ID が返る」「UI: 保存ボタン押下でトーストが表示される」
- 自動化済みの場合はテストスイートやシナリオ名、手動の場合は手順と期待値を具体的に記載する

**リスク / 相談事項**
- 不確定要素やボトルネックになりそうな点

**参考**
- 関連チケット、設計資料、ログ URL など
---

---
**テンプレート記入例 (ログイン機能)**

**サマリ**
- Email/Password ログイン API と UI を追加する

**背景 / 課題**
- 既存の試用版では認証がなく、βユーザーのみアクセスできるようにしたい
- 監査ログには未ログインアクセスが多数記録され、内部資料の閲覧リスクがある

**目的 / 成功基準**
- 認証済みユーザーのみ `/dashboard` へアクセスできる状態
- ログイン成功率 > 99% / レスポンス p95 < 200ms

**スコープ**
- Backend: `POST /v1/auth/login` の追加、既存 JWT サインロジックの再利用
- Frontend: `/login` ページ、フォームバリデーション、成功時のリダイレクト
- 対象外: ソーシャルログイン、Remember Me、MFA

**要件 / 設計**
**Backend**
- エンドポイント: `POST /v1/auth/login`
- Headers:
  | Header | 必須 | 値 | 備考 |
  | --- | --- | --- | --- |
  | Content-Type | ○ | application/json | |
  | X-Request-ID | 任意 | `<uuid>` | 監査用、無い場合はサーバ側で生成 |
- Body (Request)
  ```json
  {
    "email": "user@example.com",
    "password": "P@ssw0rd!"
  }
  ```
- Response (200)
  ```json
  {
    "token": "<jwt>",
    "expiresAt": "2024-05-01T12:00:00Z"
  }
  ```
- Errors
  - 400 `INVALID_PARAMETER`: email が不正 or password 未入力
  - 401 `INVALID_CREDENTIAL`: email/password 不一致
  - 429 `TOO_MANY_ATTEMPTS`: IP ごと 5/min を超過

**Frontend**
- ページ: `/login`。SSR 不要、CSR のみ
- イベント: SubmitButton クリック or Enter → `callLogin()` → 成功時に localStorage へ token 保存し `/dashboard` へ遷移、失敗時に `ErrorToast` で API エラー表示
- UI 状態: submit 中はボタン disable、API エラー時はフォーム上に inline message も表示、password フィールドは masked

**共通 / 非機能**
- 状態遷移図 (Miro link) を参照、Auth Boundary を ADR-012 と整合
- 監視/観測: 失敗率メトリクス `login_failures_total` の追加、p95 レイテンシを Grafana ダッシュボード Auth セクションへ表示、429/500 のアラートを Slack #alert-auth へ

**やること**
- [ ] Backend: `LoginUseCase` 作成 (ドメインバリデーション、認証コマンド、トークン生成)
- [ ] Backend: Repository/Wire 配線・`POST /v1/auth/login` ハンドラ追加
- [ ] Backend: メトリクス (`login_failures_total`) と監査ログ出力
- [ ] Frontend: `/login` ページ UI とバリデーション/トースト制御
- [ ] Frontend: API 呼び出しと成功/失敗時の遷移確認
- [ ] Docs/Runbook: `docs/context/auth.md` + Grafana ダッシュボード更新手順

**完了条件**
- [ ] `make test-unit`, `make test-integration` パス
- [ ] ログイン成功/失敗の UI シナリオを検証済み
- [ ] `docs/context/auth.md` を更新

**テスト (受け入れ観点)**
- 正常系: valid credential で 200 + JWT が返り `/dashboard` に遷移
- 異常系: パスワード誤りで 401、UI でエラーが表示される
- Rate limit: 6 回連続失敗で 429、UI では「一定時間後に再試行」のメッセージ
- Observability: `login_failures_total` が増分し、Grafana にグラフが描画される

**リスク / 相談事項**
- 既存ユーザーのパスワードハッシュ形式が bcrypt で揃っているか要確認
- インフラ環境の Rate Limit 設定と競合しないか SRE と要すり合わせ

**参考**
- RFC-7425 Auth Spec, ADR-012 Auth Boundary, Miro State Diagram, Design Doc https://...
---

## TDD ベースの開発フロー
1. **準備 (Plan)**
   - チケットの完了条件をテスト観点に落とし、どの層 (ユニット / インテグレーション / UI) で検証するかを決める
   - 新規 API ならリクエスト・レスポンス例、ドメインルールなら境界値を列挙しておく
2. **Red**
   - 期待する振る舞いを表すテストを先に書き、失敗することを確認する
   - 名前付きテーブルテストやシナリオテストで、要件と同じ語彙を使う
3. **Green**
   - テストをパスさせるための最小限の実装を行う
   - 外部依存はモック化し、副作用がある処理は 1 箇所に閉じ込める
   - `make test-unit` や対象テストのみを走らせ、Red→Green のフィードバックを素早く得る
4. **Refactor**
   - 重複や命名、抽象度を見直し、実装意図が読みやすい形に整える
   - ログ、テレメトリ、エラーハンドリングなど品質面の TODO を片付ける
   - テストケースを補強し、境界値や異常系が抜けていないか確認
5. **セルフレビュー**
   - セキュリティ: SQL/コマンドインジェクション、XSS、CSRF、認証・認可の抜け、秘密情報のログ出力、入力検証の有無を確認
   - パフォーマンス: N+1、不要なループ/シリアル処理、キャッシュ可否、外部 API 呼び出し回数やタイムアウト設定を点検
   - 可読性/設計: 命名が意図を表しているか、単一責任か、依存方向がアーキテクチャ規約に従っているか、重複やマジックナンバーが残っていないか
   - 運用/観測可能性: ログやメトリクスが追加されたか、アラート閾値への影響やロールバック手順が明確か
   - UX/アクセシビリティ (UI 変更時): フォーカス移動、キーボード操作、エラーメッセージ、文言の整合性を確認
   - コーディング規約: `docs/guidlines/backend-coding-guidline.md` など既存ガイドラインに沿った記述・命名・フォーマットになっているか
6. **実装完了チェック**
   - 全テスト (`make test-unit`, 必要なら `make test-integration`) を実行して結果を記録
   - フォーマット/静的解析 (`make lint`) を実行して結果を記録
   - チケットの完了条件を 1 つずつ確認し、満たされていない場合はタスクへ差し戻す
   - PR 作成時はテスト結果・影響範囲・ロールバック方法をチケット or PR 説明に貼る

### 運用上の Tips
- フローを通じて WIP を小さく保つ。複数タスクを並行する場合も各タスクで Red→Green→Refactor のサイクルを完結させてから次に進む
- 不確定要素が Red の時点で解決できない場合は、チケットにリスクとして追記し相談する
- TDD のテストから逆算して設計メモを残し、レビューでは「テストが意図を担保できているか」を軸に議論する
