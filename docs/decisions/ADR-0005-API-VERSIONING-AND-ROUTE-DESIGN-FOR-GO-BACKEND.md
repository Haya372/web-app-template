# ADR-0005: API Versioning and Route Design for go-backend

Date: 2026-02-15  
Status: Accepted

---

## Context
`go-backend` の公開 HTTP API に対して、バージョニング規約とルート命名規約を定義する必要がある。

### Background
- `go-backend` は継続的な API 追加・変更を前提とする。
- API 利用者に対して、互換性境界と移行期間を明確に提示できる運用が必要である。
- ルート命名の一貫性がない場合、ドキュメント・実装・監視の整合維持が難しくなる。

### Scope
- 対象: 公開 API のパス設計、バージョン付与ルール、破壊的変更時の運用。
- 対象外: API 仕様記述フォーマット（OpenAPI 等）の採用可否、認可方式の詳細、非公開運用用エンドポイントの設計。

### Constraints
- 既存クライアントへの影響を制御可能であること。
- ルート規約はレビュー時に機械的に判定できる明確さを持つこと。

## Decision
`go-backend` の公開 API には、URI メジャーバージョニングを採用する。

- 公開 API は `/v{major}/...` 形式を必須とする。
- リソース名は複数形・小文字・ケバブケースを基本とする。
- 認証操作はリソース配下または認証リソース配下に配置する（例: `/v1/users/login`, `/v1/auth/login`）。

破壊的変更の判定基準:

Request（クライアント -> サーバ）:

| 変更内容 | 判定 | 理由 |
| --- | --- | --- |
| 必須フィールドの追加 | 破壊的 | 既存クライアントが送信条件を満たせず失敗する。 |
| 既存フィールドの削除・名称変更・型変更 | 破壊的 | 既存クライアントの送信フォーマットと非互換になる。 |
| 任意フィールドの追加 | 非破壊的 | 既存クライアントの送信内容を変更せず利用可能。 |
| 後方互換を維持したバリデーション強化 | 非破壊的 | 既存正常系を壊さない範囲であれば互換性を維持できる。 |

Response（サーバ -> クライアント）:

| 変更内容 | 判定 | 理由 |
| --- | --- | --- |
| 既存フィールドの削除・名称変更・型変更 | 破壊的 | 既存クライアントのパース/表示ロジックと非互換になる。 |
| 成功時 HTTP ステータスの意味変更 | 破壊的 | クライアントの分岐処理と監視条件に影響する。 |
| エラーコードの意味変更や削除 | 破壊的 | リトライ・表示・ハンドリング方針が崩れる。 |
| フィールドの追加 | 非破壊的 | 既存クライアントは未知フィールドを無視して継続利用できる。 |
| 新規エンドポイントの追加 | 非破壊的 | 既存クライアントの利用経路に影響しない。 |

補足:
- 同じ「フィールド追加」でも、Request は必須化を伴う場合に破壊的、Response は非破壊的として扱う。

運用ルール:
- 破壊的変更を行う場合は、新メジャーを追加し旧メジャーを一定期間並行提供する。
- 旧メジャーの廃止日と移行手順を `docs/operations` に明記する。
- ルート追加・変更の PR では、破壊的変更該当性の判定結果を記載する。

## Options

### Option A: URI メジャーバージョニング（採用）
- 概要
  - パスにメジャーバージョンを含め、互換性境界を明示する。
- Pros
  - クライアント・ログ・監視でバージョンを容易に判別できる。
  - 破壊的変更時の並行提供と段階移行がしやすい。
  - ルーティング規約を単純に保てる。
- Cons
  - URL が長くなる。
  - 旧版と新版の並行運用コストが発生する。
- 想定ユースケース / 制約
  - 継続的に拡張される API バックエンド。

### Option B: ヘッダベースバージョニング
- 概要
  - ヘッダで API バージョンを切り替える。
- Pros
  - URL を短く保てる。
- Cons
  - デバッグ・運用でバージョン判別が難しくなる。
  - クライアント実装負荷が上がりやすい。
- 想定ユースケース / 制約
  - API ゲートウェイで一元制御する体制。

### Option C: バージョニングなし
- 概要
  - 常に最新 API のみを提供する。
- Pros
  - 初期実装は最も簡単。
- Cons
  - 破壊的変更時に移行を制御できない。
  - 利用者への互換性保証が弱い。
- 想定ユースケース / 制約
  - 短命・限定利用の API。

## Rationale
重要な判断軸は、互換性管理の明確さ、運用容易性、レビュー容易性である。  
URI メジャーバージョニングは、破壊的変更の境界を API パスに直接反映でき、移行計画も管理しやすい。  
ヘッダ方式は柔軟だが運用負荷が高く、バージョニングなしは長期運用に不向きである。

## Consequences
- Positive
  - 破壊的変更の判定基準が明文化され、設計レビューの品質が上がる。
  - クライアント移行計画を事前に提示しやすくなる。
  - API 仕様と運用手順の整合が取りやすくなる。

- Negative
  - 複数メジャー並行期間の運用コストが増える。
  - 廃止計画の管理を継続的に行う必要がある。

- Migration / Follow-up
  - API 変更時のチェックリストに「破壊的変更該当性」を追加する。
  - 廃止予定バージョンの告知・期限管理を `docs/operations` に追加する。

## References
- [ADR-0001: Web Framework for go-backend](./ADR-0001-WEB-FRAMEWORK.md)
- [ADR-0004: Clean Architecture for go-backend](./ADR-0004-CLEAN-ARCHITECTURE-FOR-GO-BACKEND.md)
